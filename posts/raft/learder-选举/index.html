<!DOCTYPE html>
<html lang="zh-cn">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.102.1" />
  <title>  | bilosikia </title>
  <link rel="stylesheet" href="https://bilosikia.github.io/css/simpleness.css">
  <link rel="canonical" href="https://bilosikia.github.io/posts/raft/learder-%E9%80%89%E4%B8%BE/">
  <link rel="alternate" type="application/rss+xml" href="" title="bilosikia">
  
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" rel="stylesheet">
  
</head>
<body class="container">
  <nav class="navigation">
  <div class="nav-left">
    
    <a href="https://bilosikia.github.io/">bilosikia</a>
    
    <div class="nav-item nav-title">
      <a href="https://bilosikia.github.io/"> bilosikia</a>
    </div>
    <div class="nav-item nav-menu">
      
    </div>
  </div>
  <div class="nav-item nav-right fontawesome">
    
    
    
  </div>
</nav>

  
<article class="post">
  <header class="post-header">
    <h1 style="text-align: center;" ></h1>
    <div class="post-metadata">
    
    
    
    
    
    
    </div>
  </header>

  

  <div class="post-text">
    <h1 id="为什么一般为奇数个节点">为什么一般为奇数个节点</h1>
<ul>
<li>方便投票，避免均衡投票</li>
<li>奇数节点增加一个节点，并不能提高节点容错。3 个节点，允许一个接口挂掉，4 个节点时，也只能允许一个节点挂掉。</li>
</ul>
<h1 id="如何判断发起vote请求的节点log至少和当前一样新">如何判断发起vote请求的节点log至少和当前一样新</h1>
<ul>
<li>log中的 term 谁大谁更新</li>
<li>term 号相同时，logid 越大越新</li>
</ul>
<p>注意比较的是当前 log 中的term，并不是 currentTerm。但如果发起方 term 比当前低，直接拒绝。如果比当前新，不管是否投票，都要更新 term 号。</p>
<h1 id="为什么需要预选举以及是怎么工作的">为什么需要预选举，以及是怎么工作的</h1>
<p>为什么需要：</p>
<p>只要 rpc 请求方的 term 号更大，不管当前是什么角色，都会转为 follower。被隔离的节点发起 vote 会不断的增加 term 号，导致重新选主。</p>
<p>如何工作：</p>
<ul>
<li>baseline election timeout 内每一收到过 Leader 心跳</li>
<li>Candidate 日志足够新</li>
</ul>
<p>因此无法增加 term，重新加入集群时不会导致重新选主</p>
<h1 id="为什么-term-号只能单调递增">为什么 term 号只能单调递增？</h1>
<p>为什么收到 vote，append（包括心跳）时，如果 term 号比当前大，要更新 term 号呢？</p>
<p>如果是 vote，如果判断发起节点 log 比当前旧，不会赞成投票，为什么还需要更新 term 号呢？</p>
<ul>
<li>term 和 logid 能唯一标志一条 log，故 term 只能是单调递增</li>
<li>append 请求，没法判断发起节点 log 是否比当前旧，故只能被动更新 term</li>
<li>不用记录 term 更低的投票，因为他们不可能赢得选举</li>
<li>选举期间，如果有更高 term 直接转为 follower，即便曾经的 vote 请求得到了多数的赞成，可以直接当做选举失败处理。</li>
</ul>
<p>另外，预选举由于请求的 term 号没有增加，不会让其他节点更新 term。</p>
<h1 id="有可能脑裂吗被隔离的主节点能提供读服务吗">有可能脑裂吗，被隔离的主节点，能提供读服务吗</h1>
<p>旧主只有不收到请求，就不知道是否已经有新主了，会一直认为自己是 leader，还可以提供读服务，但写将失败。</p>
<p>业务需要有机制通知客户端 leader 变更。</p>
<h1 id="心跳会增加-logid-吗entity-logid-一定是连续的吗">心跳会增加 logid 吗，entity logid 一定是连续的吗</h1>
<p>心跳会增加 log，同 entity，故 entity 的 logid 不一定连续。</p>
<h1 id="为什么一次变更一个成员没有问题一次变化多个节点有问题">为什么一次变更一个成员没有问题，一次变化多个节点有问题？</h1>
<p>举个例子，3 个节点增加一个节点变为 4 个节点。旧集群需要 2 个投票，新集群需要 3 个投票，除了新节点自己，还需要旧集群的两个。</p>
<p>如果一次增加两个变为 5 个节点，只需要旧集群的一票就可以被选举为新主，导致脑裂。</p>
<p>如果一个节点收到成员变更 commit（多个成员变更），但未提交，不管该节点使用旧配置或新配置，都有可能脑裂。</p>
<p>如果使用新配置，如 5 个节点增加 4 个节点，新集群 9 个，需要 5 票，老集群 5 个，需要 4 票，从而导致脑裂。</p>
<p>但是，一次变更一个成员的方式，虽然不会造成脑裂，但存在正确性和可用性问题。</p>
<p>Raft单步变更过程中如果发生Leader切换会出现正确性问题，可能导致已经提交的日志又被覆盖。</p>
<p>参考：<a href="https://mp.weixin.qq.com/s?__biz=MzIzOTU0NTQ0MA==&amp;mid=2247502807&amp;idx=1&amp;sn=c4978ad2968c69d3a9c2f4573d78263d&amp;chksm=e92af6d8de5d7fce822edd4ffbe86a7a92c98ec8cf8c580d4d634ed8c9bcb6a319b0441ad308&amp;scene=178&amp;cur_album_id=1409150425835831296#rd">Raft成员变更的工程实践</a></p>
<p>变更提交后生效能避免正确性问题。</p>
<h1 id="单成员变更什么时候可以使用新配置">单成员变更，什么时候可以使用新配置</h1>
<p>提交生效，未提交生效都可以。</p>
<h1 id="成员变更如何让老节点下线">成员变更如何让老节点下线</h1>
<h1 id="如何判断log是否冲突">如何判断log是否冲突</h1>
<h1 id="前任的-log为何不能复制并提交">前任的 log，为何不能复制并提交</h1>
<p>需要已自己的 term 去提交。</p>
<h1 id="为什么引入-learner">为什么引入 learner</h1>
<ul>
<li>新加入的节点，导致集群可用性变差</li>
</ul>
<h1 id="etcd-leader-select">Etcd leader select</h1>
<h2 id="接收端">接收端</h2>
<h2 id="发起端">发起端</h2>
<h1 id="成员变更">成员变更</h1>
<ul>
<li>一次添加一个新节点没有问题</li>
<li>一次添加多个节点
<ul>
<li>节点有未提交的配置
<ul>
<li>不能直接使用之前的配置</li>
<li>也不能直接使用未提交配置</li>
</ul>
</li>
<li>两阶段提交
<ul>
<li>先提交一次 Cnew -&gt; Cold, 无需提交，立即生效</li>
<li>但是之后选举时，要求同时得到新/旧集群大多数选票</li>
<li>待 Cnew -&gt; Cold 被提交后，再发起一次 Cnew 的提交</li>
</ul>
</li>
</ul>
</li>
<li>新节点没有之前的 log, 无法直接参与日程的追加，导致可用性变差
<ul>
<li>问：想想为什么会变差？</li>
<li>引入learner 身份，没有投票权</li>
</ul>
</li>
</ul>

  </div>

  <footer class="post-footer">
    

    

    
    
  </footer>
  
</article>

</body>
  



</html>
