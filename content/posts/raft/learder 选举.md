# 为什么一般为奇数个节点

- 方便投票，避免均衡投票
- 奇数节点增加一个节点，并不能提高节点容错。3 个节点，允许一个接口挂掉，4 个节点时，也只能允许一个节点挂掉。

# 如何判断发起vote请求的节点log至少和当前一样新

- log中的 term 谁大谁更新
- term 号相同时，logid 越大越新

注意比较的是当前 log 中的term，并不是 currentTerm。但如果发起方 term 比当前低，直接拒绝。如果比当前新，不管是否投票，都要更新 term 号。

# 为什么需要预选举，以及是怎么工作的

为什么需要：

只要 rpc 请求方的 term 号更大，不管当前是什么角色，都会转为 follower。被隔离的节点发起 vote 会不断的增加 term 号，导致重新选主。

如何工作：

-  baseline election timeout 内每一收到过 Leader 心跳
- Candidate 日志足够新

因此无法增加 term，重新加入集群时不会导致重新选主

# 为什么 term 号只能单调递增？

为什么收到 vote，append（包括心跳）时，如果 term 号比当前大，要更新 term 号呢？

如果是 vote，如果判断发起节点 log 比当前旧，不会赞成投票，为什么还需要更新 term 号呢？

- term 和 logid 能唯一标志一条 log，故 term 只能是单调递增
- append 请求，没法判断发起节点 log 是否比当前旧，故只能被动更新 term
- 不用记录 term 更低的投票，因为他们不可能赢得选举
- 选举期间，如果有更高 term 直接转为 follower，即便曾经的 vote 请求得到了多数的赞成，可以直接当做选举失败处理。

另外，预选举由于请求的 term 号没有增加，不会让其他节点更新 term。

# 有可能脑裂吗，被隔离的主节点，能提供读服务吗

旧主只有不收到请求，就不知道是否已经有新主了，会一直认为自己是 leader，还可以提供读服务，但写将失败。

业务需要有机制通知客户端 leader 变更。

# 心跳会增加 logid 吗，entity logid 一定是连续的吗

心跳会增加 log，同 entity，故 entity 的 logid 不一定连续。



# 为什么一次变更一个成员没有问题，一次变化多个节点有问题？

举个例子，3 个节点增加一个节点变为 4 个节点。旧集群需要 2 个投票，新集群需要 3 个投票，除了新节点自己，还需要旧集群的两个。

如果一次增加两个变为 5 个节点，只需要旧集群的一票就可以被选举为新主，导致脑裂。



如果一个节点收到成员变更 commit（多个成员变更），但未提交，不管该节点使用旧配置或新配置，都有可能脑裂。

如果使用新配置，如 5 个节点增加 4 个节点，新集群 9 个，需要 5 票，老集群 5 个，需要 4 票，从而导致脑裂。



但是，一次变更一个成员的方式，虽然不会造成脑裂，但存在正确性和可用性问题。

Raft单步变更过程中如果发生Leader切换会出现正确性问题，可能导致已经提交的日志又被覆盖。

参考：[Raft成员变更的工程实践](https://mp.weixin.qq.com/s?__biz=MzIzOTU0NTQ0MA==&mid=2247502807&idx=1&sn=c4978ad2968c69d3a9c2f4573d78263d&chksm=e92af6d8de5d7fce822edd4ffbe86a7a92c98ec8cf8c580d4d634ed8c9bcb6a319b0441ad308&scene=178&cur_album_id=1409150425835831296#rd)

变更提交后生效能避免正确性问题。

# 单成员变更，什么时候可以使用新配置

提交生效，未提交生效都可以。



# 成员变更如何让老节点下线



# 如何判断log是否冲突



# 前任的 log，为何不能复制并提交

需要已自己的 term 去提交。

# 为什么引入 learner

- 新加入的节点，导致集群可用性变差

# Etcd leader select

## 接收端



## 发起端



# 成员变更

- 一次添加一个新节点没有问题
- 一次添加多个节点
  - 节点有未提交的配置
    - 不能直接使用之前的配置
    - 也不能直接使用未提交配置
  - 两阶段提交
    - 先提交一次 Cnew -> Cold, 无需提交，立即生效
    - 但是之后选举时，要求同时得到新/旧集群大多数选票
    - 待 Cnew -> Cold 被提交后，再发起一次 Cnew 的提交
- 新节点没有之前的 log, 无法直接参与日程的追加，导致可用性变差
  - 问：想想为什么会变差？
  - 引入learner 身份，没有投票权